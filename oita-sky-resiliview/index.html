<!--
===============================================================================
 OITA SKY RESILI-VIEWï¼ˆå¤§åˆ†ã‚¹ã‚«ã‚¤ãƒ»ãƒ¬ã‚¸ãƒªãƒ“ãƒ¥ãƒ¼ï¼‰
 ã€Œçµ¶æ™¯ã§ç™’ã‚„ã—ã€ç©ºã®ç›®ã§å‘½ã‚’å®ˆã‚‹ã€‚ã€
===============================================================================

ã€æœ¬ç•ªç’°å¢ƒæ¨å¥¨ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã€‘
oita-sky-resiliview/
â”œâ”€â”€ index.html                  # ãƒ¡ã‚¤ãƒ³HTMLãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ img/
â”‚   â”‚   â”œâ”€â”€ 360_view.jpg        # è¦³å…‰ãƒ¢ãƒ¼ãƒ‰ç”¨360åº¦ç”»åƒï¼ˆåˆ¥åºœæ¹¾ãƒ»æ¹¯å¸ƒé™¢ç©ºæ’®ï¼‰
â”‚   â”‚   â””â”€â”€ 360_hazard.jpg      # é˜²ç½ãƒ¢ãƒ¼ãƒ‰ç”¨360åº¦ç”»åƒï¼ˆãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—åŠ å·¥æ¸ˆã¿ï¼‰
â”‚   â”œâ”€â”€ audio/
â”‚   â”‚   â”œâ”€â”€ nature_ambience.mp3 # è¦³å…‰ãƒ¢ãƒ¼ãƒ‰BGMï¼ˆé³¥ã®ã•ãˆãšã‚Šç­‰ï¼‰
â”‚   â”‚   â””â”€â”€ alert_tone.mp3      # é˜²ç½ãƒ¢ãƒ¼ãƒ‰è­¦å‘ŠéŸ³
â”‚   â””â”€â”€ icons/
â”‚       â”œâ”€â”€ shelter.png         # é¿é›£æ‰€ã‚¢ã‚¤ã‚³ãƒ³
â”‚       â””â”€â”€ warning.png         # è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³
â”œâ”€â”€ css/
â”‚   â””â”€â”€ style.css               # å¤–éƒ¨CSSï¼ˆæœ¬ç•ªæ™‚åˆ†é›¢æ¨å¥¨ï¼‰
â”œâ”€â”€ js/
â”‚   â””â”€â”€ app.js                  # å¤–éƒ¨JavaScriptï¼ˆæœ¬ç•ªæ™‚åˆ†é›¢æ¨å¥¨ï¼‰
â””â”€â”€ README.md                   # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª¬æ˜

===============================================================================
-->
<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="å¤§åˆ†ã®çµ¶æ™¯ã‚’360åº¦VRã§ä½“é¨“ã€‚è¦³å…‰ã¨é˜²ç½ã‚’èåˆã—ãŸãƒ•ã‚§ãƒ¼ã‚ºãƒ•ãƒªãƒ¼Webã‚¢ãƒ—ãƒªã€‚">
  <title>OITA SKY RESILI-VIEW | å¤§åˆ†ã‚¹ã‚«ã‚¤ãƒ»ãƒ¬ã‚¸ãƒªãƒ“ãƒ¥ãƒ¼</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- A-Frame Event Set Component (for hover effects) -->
  <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>

  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <!-- Loading & Start Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner" id="loadingSpinner"></div>
      <p class="loading-text" id="loadingText">ğŸŒ„ çµ¶æ™¯ã‚’æº–å‚™ä¸­...</p>
      <button class="start-button" id="startButton">VRä½“é¨“ã‚’å§‹ã‚ã‚‹ â–¶</button>
    </div>
  </div>

  <!-- Header Logo -->
  <div class="header-logo">
    <h1>OITA SKY RESILI-VIEW</h1>
    <p>çµ¶æ™¯ã§ç™’ã‚„ã—ã€ç©ºã®ç›®ã§å‘½ã‚’å®ˆã‚‹ã€‚</p>
  </div>

  <!-- CTA Button - Conversion Area -->
  <div class="cta-container">
    <p class="cta-subtext">âœ¨ è‡ªåˆ†ã‚‚ç©ºã‚’é£›ã³ãŸã„ï¼</p>
    <a href="https://skyfivedrone.com/" target="_blank" rel="noopener noreferrer" class="cta-button">
      ã“ã®æ˜ åƒã‚’æ’®ã£ãŸãƒ‘ã‚¤ãƒ­ãƒƒãƒˆã«ãªã‚‹ã«ã¯ï¼Ÿ â–¶
    </a>
  </div>

  <!-- Warning Banner (Disaster Mode) -->
  <div class="warning-banner" id="warningBanner">
    é˜²ç½ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šæ´¥æ³¢ãƒ»æ´ªæ°´ãƒã‚¶ãƒ¼ãƒ‰è¡¨ç¤ºä¸­
  </div>

  <!-- Disaster Overlay -->
  <div class="disaster-overlay" id="disasterOverlay"></div>

  <!-- Mini Map with Google Maps Embed -->
  <div class="mini-map-container" id="miniMap">
    <div class="mini-map-header">ğŸ“ ç¾åœ¨åœ°</div>
    <button class="mini-map-toggle" onclick="toggleMiniMap()" title="åœ°å›³ã‚’é–‹é–‰">âˆ’</button>
    <!-- ä¸Šæ‘ã®éƒ·ï¼ˆ33.42348, 131.44203ï¼‰ -->
    <iframe
      src="https://www.google.com/maps/embed?pb=!1m17!1m12!1m3!1d3000!2d131.44203!3d33.42348!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m2!1m1!2zMzPCsDI1JzI0LjUiTiAxMzHCsDI2JzMxLjMiRQ!5e1!3m2!1sja!2sjp!4v1707200000000"
      loading="lazy" referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>

  <!-- A-Frame VR Scene -->
  <a-scene embedded vr-mode-ui="enabled: true" loading-screen="enabled: false"
    renderer="antialias: true; colorManagement: true" id="vrScene">

    <!-- Asset Management -->
    <a-assets timeout="30000">
      <!-- 
        æœ¬ç•ªç’°å¢ƒã§ã¯ä»¥ä¸‹ã®ç”»åƒãƒ‘ã‚¹ã‚’ä½¿ç”¨:
        - è¦³å…‰ãƒ¢ãƒ¼ãƒ‰: ./assets/img/360_view.jpg
        - é˜²ç½ãƒ¢ãƒ¼ãƒ‰: ./assets/img/360_hazard.jpg
        
        ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ãƒ‡ãƒ¢ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ç”»åƒã‚’ä½¿ç”¨
      -->
      <img id="sky-tourism" src="./assets/img/360_view.jpg" alt="è¦³å…‰ãƒ¢ãƒ¼ãƒ‰360åº¦èƒŒæ™¯">
      <img id="sky-disaster" src="https://images.unsplash.com/photo-1534088568595-a066f410bcda?w=4096&q=80"
        crossorigin="anonymous" alt="é˜²ç½ãƒ¢ãƒ¼ãƒ‰360åº¦èƒŒæ™¯">
    </a-assets>

    <!-- 360 Sky Background Logic
         Wrapper: Handles Horizontal Auto-Rotation (Y-axis)
         Inner: Handles Orientation Correction (Z-axis -90deg roll)
    -->
    <a-entity id="skybox-wrapper" rotation="0 0 0">
      <a-sky id="skybox" src="#sky-tourism" rotation="0 -299 -90"></a-sky>
    </a-entity>

    <!-- Camera with Gaze Cursor -->
    <a-camera look-controls="magicWindowTrackingEnabled: true; touchEnabled: true" wasd-controls="enabled: false"
      position="0 1.6 0">
      <!-- Gaze Cursor (è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«) -->
      <!-- Gaze Cursor (è¦–ç·šã‚«ãƒ¼ã‚½ãƒ«) - Hidden as requested -->
      <a-entity cursor="fuse: true; fuseTimeout: 1500" position="0 0 -1" visible="false"
        geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" material="color: #FFD700; shader: flat"
        raycaster="objects: .clickable">
      </a-entity>
      <!-- Center Reticle -->
      <a-entity geometry="primitive: circle; radius: 0.003" material="color: white; shader: flat" position="0 0 -1">
      </a-entity>
    </a-camera>

    <!-- VR UI Panel (VRç©ºé–“å†…ã®UI) - Hidden for cleaner view - REMOVED to prevent accidental clicks -->
    <!-- (Original code removed: ctaVRPanel was here) -->

    <!-- Tourism Mode Labels (Hidden for now) -->
    <!-- 
    <a-entity id="tourismLabels" visible="false">
      <a-entity position="-8 2 -10" look-at="[camera]"
        text="value: ğŸ”ï¸ åˆ¥åºœæ¸©æ³‰ï¼ˆæ¹¯ã‘ã‚€ã‚Šï¼‰; color: #4CAF50; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 3.5; height: 0.6" material="color: #1a1a1a; opacity: 0.8">
      </a-entity>

      <a-entity position="10 3 -8" look-at="[camera]"
        text="value: ğŸŒ¿ æ¹¯å¸ƒé™¢ãƒ»é‡‘é±—æ¹–; color: #4CAF50; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 3; height: 0.6" material="color: #1a1a1a; opacity: 0.8">
      </a-entity>

      <a-entity position="0 4 -15" look-at="[camera]"
        text="value: ğŸŒŠ åˆ¥åºœæ¹¾ãƒ‘ãƒãƒ©ãƒ; color: #4CAF50; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 3; height: 0.6" material="color: #1a1a1a; opacity: 0.8">
      </a-entity>
    </a-entity>
    -->

    <!-- Disaster Mode Labels (Initially Hidden) -->
    <!--
    <a-entity id="disasterLabels" visible="false">
      <a-entity position="-8 2 -10" look-at="[camera]"
        text="value: â›‘ï¸ ä¸€æ™‚é¿é›£æ‰€ï¼ˆé«˜å°ï¼‰; color: #ff5252; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 4; height: 0.6" material="color: #1a1a1a; opacity: 0.9">
      </a-entity>

      <a-entity position="10 1 -8" look-at="[camera]"
        text="value: âš ï¸ æ´¥æ³¢åˆ°é”ãƒ©ã‚¤ãƒ³ï¼ˆã“ã“ã¾ã§æ¥ã‚‹ï¼‰; color: #ff1744; align: center; width: 8; font: mozillavr"
        geometry="primitive: plane; width: 5.5; height: 0.6" material="color: #b71c1c; opacity: 0.9">
      </a-entity>

      <a-entity position="0 2 -12" look-at="[camera]"
        text="value: ğŸš¨ æµ¸æ°´æƒ³å®šã‚¨ãƒªã‚¢; color: #ff5252; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 3.5; height: 0.6" material="color: #1a1a1a; opacity: 0.9">
      </a-entity>

      <a-entity position="5 3 -10" look-at="[camera]"
        text="value: ğŸ“ åºƒåŸŸé¿é›£å ´æ‰€ã¾ã§å¾’æ­©8åˆ†; color: #ffeb3b; align: center; width: 6; font: mozillavr"
        geometry="primitive: plane; width: 4.5; height: 0.6" material="color: #1a1a1a; opacity: 0.9">
      </a-entity>
    </a-entity>
    -->

  </a-scene>

  <!-- Scene Transition Overlay -->
  <div class="scene-transition-overlay" id="sceneTransition"></div>

  <!-- Current Scene Label - Hidden for single scene -->
  <div class="current-scene-label" id="currentSceneLabel" style="display: none;">
    ğŸ“ <span id="sceneNameDisplay">å±•æœ›ãƒã‚¤ãƒ³ãƒˆ1</span>
  </div>

  <!-- Scene Navigation Thumbnails - Visible for navigation -->
  <div class="scene-nav-container" id="sceneNavContainer" style="display: flex;">
    <!-- Dynamically populated by JavaScript -->
  </div>

  <!-- Mode Switch Buttons -->
  <div class="mode-switch-container">
    <button class="mode-btn mode-btn-tourism active" id="btnTourism" onclick="switchMode('tourism')">
      <span>ğŸï¸</span> ç™’ã‚„ã—ã®çµ¶æ™¯ã‚’è¦‹ã‚‹
    </button>
    <button class="mode-btn mode-btn-disaster" id="btnDisaster" onclick="switchMode('disaster')" style="display: none">
      <span>â›‘ï¸</span> ã‚‚ã—ã‚‚ã®å‚™ãˆï¼ˆç”Ÿå­˜ãƒ«ãƒ¼ãƒˆï¼‰
    </button>
  </div>

  <!-- Audio Control -->
  <button class="audio-btn" id="audioBtn" onclick="toggleMute()" title="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">
    ğŸ”Š
  </button>

  <!-- Audio Assets (Hidden) -->
  <!-- 
    Note: Replace 'src' with actual file paths.
    Tourism: Nature/Birds
    Disaster: Alert/News noise
    SE: Button Click
  -->
  <audio id="bgm-tourism" loop preload="auto">
    <source src="./assets/audio/nature_ambience.mp3" type="audio/mpeg">
    <!-- Fallback/Placeholder if local file missing -->
    <source src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/city.mp3" type="audio/mpeg">
  </audio>
  <audio id="bgm-disaster" loop preload="auto">
    <source src="./assets/audio/alert_tone.mp3" type="audio/mpeg">
  </audio>
  <audio id="se-click" preload="auto">
    <source src="https://cdn.aframe.io/360-image-gallery-boilerplate/audio/click.mp3" type="audio/mpeg">
  </audio>

  <!-- Auto-Rotation Toggle Button -->
  <button class="auto-rotate-btn paused" id="autoRotateBtn" onclick="toggleAutoRotate()" title="è‡ªå‹•å›è»¢ OFF">
    â¸ï¸
  </button>

  <script>
    // ========================================
    // OITA SKY RESILI-VIEW - Main Application
    // Multi-Scene VR Tour System
    // ========================================

    // ========================================
    // Scene Configuration
    // ========================================
    const scenes = [
      {
        id: 'scene1',
        name: 'å±•æœ›ãƒã‚¤ãƒ³ãƒˆ1ï¼ˆãƒ€ãƒ å‘¨è¾ºï¼‰',
        image: './assets/img/360_view.jpg',
        rotation: '0 -139 0',
        hotspots: [
          { target: 'scene2', position: '5 1.2 -6', rotation: '0 -30 0', label: 'æ¬¡ã®åœ°ç‚¹ã¸ â†’' },
          { target: 'scene3', position: '-6 1.2 -5', rotation: '0 30 0', label: 'å±±å´ã¸ â†’' }
        ]
      },
      {
        id: 'scene2',
        name: 'å±•æœ›ãƒã‚¤ãƒ³ãƒˆ2ï¼ˆç”°åœ’é¢¨æ™¯ï¼‰',
        image: './assets/img/360_view.jpg',
        rotation: '0 -50 0',
        hotspots: [
          { target: 'scene1', position: '-5 1.2 -6', rotation: '0 30 0', label: 'â† å‰ã®åœ°ç‚¹ã¸' },
          { target: 'scene3', position: '4 1.2 -7', rotation: '0 -20 0', label: 'å±±å´ã¸ â†’' }
        ]
      },
      {
        id: 'scene3',
        name: 'å±•æœ›ãƒã‚¤ãƒ³ãƒˆ3ï¼ˆå±±é–“éƒ¨ï¼‰',
        image: './assets/img/360_view.jpg',
        rotation: '0 90 0',
        hotspots: [
          { target: 'scene1', position: '0 1.2 -8', rotation: '0 0 0', label: 'â† ãƒ€ãƒ å‘¨è¾ºã¸' },
          { target: 'scene2', position: '-6 1.2 -4', rotation: '0 40 0', label: 'â† ç”°åœ’ã¸' }
        ]
      }
    ];

    // Current state
    let currentSceneId = 'scene1';
    let currentMode = 'tourism';
    let isAutoRotating = false;
    let rotationAnimationId = null;
    let isMuted = false; // Audio state

    // DOM Elements - Audio
    const bgmTourism = document.getElementById('bgm-tourism');
    const bgmDisaster = document.getElementById('bgm-disaster');
    const seClick = document.getElementById('se-click');
    const audioBtn = document.getElementById('audioBtn');

    // ... [Original Rotation Logic] ...

    // ========================================
    // Audio Management
    // ========================================
    function playBGM() {
      if (isMuted) return;

      // Stop all first
      bgmTourism.pause();
      bgmDisaster.pause();

      // Play based on mode
      const targetBGM = currentMode === 'tourism' ? bgmTourism : bgmDisaster;

      // Reset volume (fade in could be added here)
      targetBGM.currentTime = 0;
      targetBGM.volume = 0.5;

      const playPromise = targetBGM.play();
      if (playPromise !== undefined) {
        playPromise.catch(error => {
          console.log("Audio play prevented:", error);
        });
      }
    }

    function toggleMute() {
      isMuted = !isMuted;

      if (isMuted) {
        bgmTourism.pause();
        bgmDisaster.pause();
        audioBtn.innerHTML = 'ğŸ”‡';
        audioBtn.classList.add('muted');
      } else {
        playBGM();
        audioBtn.innerHTML = 'ğŸ”Š';
        audioBtn.classList.remove('muted');
      }
    }

    function playSE(type) {
      if (isMuted) return;
      if (type === 'click') {
        seClick.currentTime = 0;
        seClick.play().catch(e => { }); // Ignore errors
      }
    }

    // ========================================
    // Cinematic Intro Animation
    // ========================================
    function playIntroAnimation() {
      const camera = document.querySelector('[camera]');
      if (!camera) return;

      // 1. Set initial VOID state (Black out is handled by loading screen, but we zoom)
      // Start with wide FOV (Zoomed out)
      camera.setAttribute('camera', 'fov', 120);

      // 2. Animate FOV to normal (80)
      let fov = 120;
      const targetFov = 80;
      const duration = 2500; // ms
      const startTime = performance.now();

      function animate(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);

        // Ease out cubic
        const ease = 1 - Math.pow(1 - progress, 3);

        const currentFov = fov - (fov - targetFov) * ease;
        camera.setAttribute('camera', 'fov', currentFov);

        if (progress < 1) {
          requestAnimationFrame(animate);
        }
      }

      requestAnimationFrame(animate);
    }

    // ... [Modified switchMode to handle Audio] ...

    /**
     * Switch between Tourism and Disaster modes
     */
    function switchMode(mode) {
      if (mode === currentMode) return;

      currentMode = mode;

      // Update Audio
      playBGM();

      if (mode === 'tourism') {
        tourismLabels.setAttribute('visible', 'true');
        disasterLabels.setAttribute('visible', 'false');
        disasterOverlay.classList.remove('active');
        warningBanner.classList.remove('active');
        btnTourism.classList.add('active');
        btnDisaster.classList.remove('active');
      } else if (mode === 'disaster') {
        tourismLabels.setAttribute('visible', 'false');
        disasterLabels.setAttribute('visible', 'true');
        disasterOverlay.classList.add('active');
        warningBanner.classList.add('active');
        btnTourism.classList.remove('active');
        btnDisaster.classList.add('active');
      }

      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    // ... [Initialization] ...

    // Start Button Click Handler (Updated with Audio/Intro)
    startButton.addEventListener('click', () => {
      // 1. Request iOS Gyro Permission
      requestDeviceOrientation();

      // 2. Play Intro Animation
      playIntroAnimation();

      // 3. Start Audio (User interaction allows this)
      playBGM();

      // 4. Hide Loading Screen
      loadingScreen.classList.add('hide');
      setTimeout(() => {
        loadingScreen.style.display = 'none';
      }, 500);

      // 5. Initialize Scene Content
      init();
    });

    // Update loadScene to play click sound
    // (Existing loadScene function needs playSE('click') added)

    // Start Y-axis only auto-rotation
    function startAutoRotation() {
      if (rotationAnimationId) return;

      function rotate() {
        if (!isAutoRotating) {
          rotationAnimationId = null;
          return;
        }

        // Three.jsã®object3Dã‚’ç›´æ¥æ“ä½œï¼ˆãƒ©ã‚¸ã‚¢ãƒ³å˜ä½ï¼‰
        // skyboxWrapper (Yè»¸å›è»¢å°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ) ã‚’å‹•ã‹ã™
        skyboxWrapper.object3D.rotation.y += 0.0005;

        rotationAnimationId = requestAnimationFrame(rotate);
      }

      rotationAnimationId = requestAnimationFrame(rotate);
    }

    // Stop auto-rotation
    function stopAutoRotation() {
      if (rotationAnimationId) {
        cancelAnimationFrame(rotationAnimationId);
        rotationAnimationId = null;
      }
    }

    // DOM Elements
    const skybox = document.getElementById('skybox');
    const skyboxWrapper = document.getElementById('skybox-wrapper');
    const tourismLabels = document.getElementById('tourismLabels');
    const disasterLabels = document.getElementById('disasterLabels');
    const disasterOverlay = document.getElementById('disasterOverlay');
    const warningBanner = document.getElementById('warningBanner');
    const btnTourism = document.getElementById('btnTourism');
    const btnDisaster = document.getElementById('btnDisaster');
    const loadingScreen = document.getElementById('loadingScreen');
    const sceneTransition = document.getElementById('sceneTransition');
    const sceneNameDisplay = document.getElementById('sceneNameDisplay');
    const sceneNavContainer = document.getElementById('sceneNavContainer');
    const hotspotsContainer = document.getElementById('hotspotsContainer');
    const aScene = document.querySelector('a-scene');

    // ========================================
    // Scene Management
    // ========================================

    /**
     * Initialize scene navigation thumbnails
     */
    function initSceneNav() {
      sceneNavContainer.innerHTML = '';
      scenes.forEach(scene => {
        const thumb = document.createElement('img');
        thumb.src = scene.image;
        thumb.className = 'scene-thumb' + (scene.id === currentSceneId ? ' active' : '');
        thumb.title = scene.name;
        thumb.alt = scene.name;
        thumb.onclick = () => loadScene(scene.id);
        sceneNavContainer.appendChild(thumb);
      });
    }

    /**
     * Load a scene by ID
     * @param {string} sceneId - The scene ID to load
     */
    function loadScene(sceneId) {
      if (sceneId === currentSceneId) return;

      playSE('click'); // Play Sound Effect

      const scene = scenes.find(s => s.id === sceneId);
      if (!scene) return;

      // Transition animation
      sceneTransition.classList.add('active');

      setTimeout(() => {
        currentSceneId = sceneId;

        // Update skybox
        skybox.setAttribute('src', scene.image);
        // Rotation (yaw/panning) is applied to the wrapper
        skyboxWrapper.setAttribute('rotation', scene.rotation);

        // Update scene name
        sceneNameDisplay.textContent = scene.name;

        // Update navigation thumbnails
        document.querySelectorAll('.scene-thumb').forEach((thumb, index) => {
          thumb.classList.toggle('active', scenes[index].id === sceneId);
        });

        // Create hotspots for this scene
        createHotspots(scene.hotspots);

        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(30);
        }

        // End transition
        setTimeout(() => {
          sceneTransition.classList.remove('active');
        }, 300);
      }, 300);
    }

    /**
     * Create VR hotspots for scene navigation
     * @param {Array} hotspots - Array of hotspot configurations
     */
    function createHotspots(hotspots) {
      // Remove existing hotspots
      const existingHotspots = document.querySelectorAll('.vr-hotspot');
      existingHotspots.forEach(h => h.parentNode.removeChild(h));

      // User requested to remove hotspots completely.
      // Skipping creation of new hotspots and returning early.
      return;
    }

    /**
     * Toggle auto-rotation of the skybox
     */
    function toggleAutoRotate() {
      const autoRotateBtn = document.getElementById('autoRotateBtn');
      isAutoRotating = !isAutoRotating;

      if (isAutoRotating) {
        startAutoRotation();
        autoRotateBtn.classList.remove('paused');
        autoRotateBtn.innerHTML = 'ğŸ”„';
        autoRotateBtn.title = 'è‡ªå‹•å›è»¢ ON';
      } else {
        stopAutoRotation();
        autoRotateBtn.classList.add('paused');
        autoRotateBtn.innerHTML = 'â¸ï¸';
        autoRotateBtn.title = 'è‡ªå‹•å›è»¢ OFF';
      }

      if (navigator.vibrate) {
        navigator.vibrate(30);
      }
    }

    /**
     * Toggle mini-map visibility
     */
    function toggleMiniMap() {
      const miniMap = document.getElementById('miniMap');
      const toggleBtn = miniMap.querySelector('.mini-map-toggle');
      miniMap.classList.toggle('collapsed');
      toggleBtn.textContent = miniMap.classList.contains('collapsed') ? '+' : 'âˆ’';
    }

    /**
     * Switch between Tourism and Disaster modes
     * @param {string} mode - 'tourism' or 'disaster'
     */
    function switchMode(mode) {
      if (mode === currentMode) return;

      currentMode = mode;

      if (mode === 'tourism') {
        tourismLabels.setAttribute('visible', 'true');
        disasterLabels.setAttribute('visible', 'false');
        disasterOverlay.classList.remove('active');
        warningBanner.classList.remove('active');
        btnTourism.classList.add('active');
        btnDisaster.classList.remove('active');
      } else if (mode === 'disaster') {
        tourismLabels.setAttribute('visible', 'false');
        disasterLabels.setAttribute('visible', 'true');
        disasterOverlay.classList.add('active');
        warningBanner.classList.add('active');
        btnTourism.classList.remove('active');
        btnDisaster.classList.add('active');
      }

      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    // ========================================
    // Initialization & Event Listeners
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      const scene = document.querySelector('a-scene');
      const startButton = document.getElementById('startButton');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const loadingText = document.getElementById('loadingText');
      const loadingScreen = document.getElementById('loadingScreen');

      // Initialize scene navigation
      initSceneNav();

      // Check when A-Frame is ready
      if (scene.hasLoaded) {
        onSceneLoaded();
      } else {
        scene.addEventListener('loaded', onSceneLoaded);
      }

      // Assets Loading Fallback (if 'loaded' event doesn't fire fast enough for assets)
      // Note: A-Frame's 'loaded' fires when the scene graph is ready, not necessarily all assets.
      // Ideally we would use an asset loader, but for this prototype we'll assume it's "Ready" 
      // when the scene is initialized.

      // Fallback timer to show Start button anyway after 4 seconds (prevent stuck loading)
      setTimeout(onSceneLoaded, 4000);

      function onSceneLoaded() {
        // Prevent double execution
        if (startButton.classList.contains('visible')) return;

        // Hide spinner, show Start button
        loadingSpinner.style.display = 'none';
        loadingText.textContent = "æº–å‚™å®Œäº†";
        startButton.classList.add('visible');
      }

      // Start Button Click Handler
      startButton.addEventListener('click', (e) => {
        // Prevent click from passing through to A-Frame scene
        e.stopPropagation();
        e.preventDefault();

        // 1. Request iOS Gyro Permission
        requestDeviceOrientation();

        // 2. Hide Loading Screen
        loadingScreen.classList.add('hide');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);

        // 3. Initialize Scene Content
        init();
      });

      function init() {
        const initialScene = scenes.find(s => s.id === currentSceneId);
        if (initialScene) {
          createHotspots(initialScene.hotspots);
        }
        // Start Y-axis only auto-rotation
        if (isAutoRotating) {
          startAutoRotation();
        }
      }
    });

    /**
     * Request Device Orientation Permission (iOS 13+)
     */
    function requestDeviceOrientation() {
      if (
        typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function'
      ) {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              console.log('DeviceOrientation permission granted');
            } else {
              console.warn('DeviceOrientation permission denied');
              alert('ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç”»é¢ã‚¹ãƒ¯ã‚¤ãƒ—ã§æ“ä½œã—ã¦ãã ã•ã„ã€‚');
            }
          })
          .catch(error => {
            console.error('DeviceOrientation request error:', error);
          });
      }
    }

    // ========================================
    // Keyboard Shortcuts (for development)
    // ========================================
    document.addEventListener('keydown', (e) => {
      if (e.key === '1') switchMode('tourism');
      if (e.key === '2') switchMode('disaster');
      // Scene shortcuts
      if (e.key === 'q') loadScene('scene1');
      if (e.key === 'w') loadScene('scene2');
      if (e.key === 'e') loadScene('scene3');
    });

    // ========================================
    // Console Welcome Message
    // ========================================
    console.log('%cğŸŒ„ OITA SKY RESILI-VIEW', 'color: #FFD700; font-size: 20px; font-weight: bold;');
    console.log('%cçµ¶æ™¯ã§ç™’ã‚„ã—ã€ç©ºã®ç›®ã§å‘½ã‚’å®ˆã‚‹ã€‚', 'color: #4CAF50; font-size: 14px;');
    console.log('%cÂ© ç„¡äººèˆªç©ºæ©Ÿå›½å®¶ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚»ãƒ³ã‚¿ãƒ¼ æ ªå¼ä¼šç¤¾ã‚¹ã‚«ã‚¤ãƒ»ãƒ•ã‚¡ã‚¤ãƒ–', 'color: #888; font-size: 12px;');
    console.log('%cã‚·ãƒ¼ãƒ³åˆ‡æ›¿: Q/W/E ã‚­ãƒ¼ | ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿: 1/2 ã‚­ãƒ¼', 'color: #888; font-size: 11px;');
  </script>

</body>

</html>